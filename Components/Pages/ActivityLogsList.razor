@page "/activitylogslist"
@rendermode InteractiveServer
@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject FindActivityLogsService _findActivityLogsService
@inject FindMasterServices _findMasterServices

<PageTitle>一覧画面</PageTitle>

<div class="container mt-4">
    <h1 class="mb-3">一覧画面</h1>

    <!-- 日付移動 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h4 class="m-0">@targetDate.ToShortDateString()</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" @onclick="() => ChangeTragetDate(-1)">前日</button>
                <button class="btn btn-outline-primary" @onclick="() => ChangeTragetDate(1)">翌日</button>
            </div>
        </div>
    </div>

    <!-- 集計エリア -->
    <div class="row mb-4">

        @foreach (var type in categoryTypeStats.OrderBy(t => t.SortOrder))
        {
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-header
                                @ColorClassBuilder.BuildBackgroundBadgeClass(
                                                    GetColorKey(type.TypeId),
                                                    GetTextColorKey(type.TypeId)
                                ) fw-bold">
                        @type.TypeName
                    </div>
                    <div class="card-body">
                        <h4>@type.TotalMinutes 分</h4>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- ログ一覧 -->
    <div class="list-group shadow-sm">
        @foreach (ActivityLogs record in _activityLogs)
        {
            string startTimeDisp = record.StartDateTime.ToShortTimeString();
            string endTimeDisp = record.EndDateTime.ToShortTimeString();

            <div class="list-group-item d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <h5 class="mb-1">
                        <span class="badge
                                         @ColorClassBuilder.BuildBackgroundBadgeClass(
                                              GetColorKey(record.CategoryMaster?.CategoryTypeMasterId),
                                              GetTextColorKey(record.CategoryMaster?.CategoryTypeMasterId)
                                          ) me-2">
                            @(record.CategoryMaster?.CategoryName ?? "(削除済みカテゴリ)")
                        </span>
                        @record.PassingRoundMinutes 分
                    </h5>
                    <small>@startTimeDisp ～ @endTimeDisp</small>
                </div>

                @if (!string.IsNullOrEmpty(record.ActivityDetailTitle))
                {
                    <a href="activitydetail/@record.Id" class="text-decoration-none mt-1">
                        🔍 @record.ActivityDetailTitle
                    </a>
                }
            </div>
        }
    </div>
</div>

@code {

    private DateTime targetDate = DateTime.Today;

    private List<ActivityLogs> _activityLogs = new();

    // 集計結果用
    private List<CategoryTypeSummary> categoryTypeStats = new();

    // カテゴリタイプマスタ
    private List<CategoryTypeMaster> categoryTypeMasterList = new();

    protected override async Task OnInitializedAsync()
    {
        categoryTypeMasterList = await _findMasterServices.FindCategoryTypeMaster();

        await LoadLogsAsync();
    }

    private async Task ChangeTragetDate(int changeDayNum)
    {
        targetDate = targetDate.AddDays(changeDayNum);
        await LoadLogsAsync();
    }

    private async Task LoadLogsAsync()
    {
        _activityLogs = await _findActivityLogsService.FindActivityLogsByDatgetDateAsync(targetDate);
        CalcSumTime();
    }

    private void CalcSumTime()
    {
        // 初期化
        categoryTypeStats = categoryTypeMasterList
            .Select(t => new CategoryTypeSummary
            {
                TypeId = t.Id,
                TypeName = t.TypeName,
                SortOrder = t.SortOrder
            })
            .ToList();

        foreach (ActivityLogs record in _activityLogs)
        {
            var typeId = record.CategoryMaster?.CategoryTypeMasterId;

            var target = categoryTypeStats.FirstOrDefault(x => x.TypeId == typeId);
            if (target != null)
            {
                target.TotalMinutes += record.PassingRoundMinutes;
            }
        }
    }

    private string GetColorKey(int? typeId)
    {
        return categoryTypeMasterList
            .FirstOrDefault(x => x.Id == typeId)?.ColorKey ?? "secondary";
    }

    private string GetTextColorKey(int? typeId)
    {
        return categoryTypeMasterList
            .FirstOrDefault(x => x.Id == typeId)?.TextColorKey ?? "white";
    }

    private class CategoryTypeSummary
    {
        public int TypeId { get; set; }
        public string TypeName { get; set; } = "";
        public double TotalMinutes { get; set; }
        public int SortOrder { get; set; }
    }
}
