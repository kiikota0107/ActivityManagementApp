@page "/activitylogslist"
@rendermode InteractiveServer
@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject FindActivityLogsService _findActivityLogsService
@inject FindMasterServices _findMasterServices

<PageTitle>一覧画面</PageTitle>

<div class="container mt-4">
    <h1 class="mb-3">一覧画面</h1>

    <div class="card mb-3 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h4 class="m-0">@targetDate.ToShortDateString()</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" @onclick="() => ChangeTragetDate(-1)">前日</button>
                <button class="btn btn-outline-primary" @onclick="() => ChangeTragetDate(1)">翌日</button>
            </div>
        </div>
    </div>

    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-header bg-warning fw-bold">娯楽</div>
                <div class="card-body">
                    <h4>@entertainmentTimeTotal 分</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-header bg-success text-white fw-bold">自己研鑽</div>
                <div class="card-body">
                    <h4>@selfImprovementTimeTotal 分</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-header bg-info text-white fw-bold">睡眠</div>
                <div class="card-body">
                    <h4>@sleepTimeTotal 分</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">仕事</div>
                <div class="card-body">
                    <h4>@workTimeTotal 分</h4>
                </div>
            </div>
        </div>

    </div>

    <div class="list-group shadow-sm">
        @foreach (ActivityLogs record in _activityLogs)
        {
            string startTimeDisp = record.StartDateTime.ToShortTimeString();
            string endTimeDisp = record.EndDateTime.ToShortTimeString();
            var colorClass = GetCategoryColor(record.Category);

            <div class="list-group-item d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <h5 class="mb-1">
                        <span class="badge @colorClass me-2">@record.Category</span>
                        @record.PassingRoundMinutes 分
                    </h5>
                    <small>@startTimeDisp ～ @endTimeDisp</small>
                </div>

                @if (!string.IsNullOrEmpty(record.ActivityDetailTitle))
                {
                    <a href="activitydetail/@record.Id" class="text-decoration-none mt-1">
                        🔍 @record.ActivityDetailTitle
                    </a>
                }
            </div>
        }
    </div>
</div>

@code {
    private DateTime targetDate = DateTime.Today;

    private double entertainmentTimeTotal;
    private double selfImprovementTimeTotal;
    private double sleepTimeTotal;
    private double workTimeTotal;

    private List<string> entertainmentList = new();
    private List<string> selfImprovementList = new();
    private List<string> sleepList = new();
    private List<string> workList = new();
    private List<ActivityLogs> _activityLogs = new();

    protected override async Task OnInitializedAsync()
    {
        List<CategoryMaster>? categoryMasters = await _findMasterServices.FindCategoryMaster();

        if (categoryMasters == null) return;

        foreach (CategoryMaster record in categoryMasters)
        {
            if (record.CategoryTypeMasterId == 1)
                entertainmentList.Add(record.CategoryName);
            else if (record.CategoryTypeMasterId == 2)
                selfImprovementList.Add(record.CategoryName);
            else if (record.CategoryTypeMasterId == 3)
                sleepList.Add(record.CategoryName);
            else if (record.CategoryTypeMasterId == 4)
                workList.Add(record.CategoryName);
        }

        _activityLogs = await _findActivityLogsService.FindActivityLogsByDatgetDate(targetDate);
        CalcSumTime(_activityLogs);
    }

    private async Task ChangeTragetDate(int changeDayNum)
    {
        entertainmentTimeTotal = selfImprovementTimeTotal = sleepTimeTotal = workTimeTotal = 0;
        targetDate = targetDate.AddDays(changeDayNum);
        _activityLogs = await _findActivityLogsService.FindActivityLogsByDatgetDate(targetDate);
        CalcSumTime(_activityLogs);
    }

    private void CalcSumTime(List<ActivityLogs> activityLogs)
    {
        foreach (ActivityLogs record in activityLogs)
        {
            if (entertainmentList.Contains(record.Category ?? ""))
                entertainmentTimeTotal += record.PassingRoundMinutes;
            else if (selfImprovementList.Contains(record.Category ?? ""))
                selfImprovementTimeTotal += record.PassingRoundMinutes;
            else if (sleepList.Contains(record.Category ?? ""))
                sleepTimeTotal += record.PassingRoundMinutes;
            else if (workList.Contains(record.Category ?? ""))
                workTimeTotal += record.PassingRoundMinutes;
        }
    }

    private string GetCategoryColor(string? category)
    {
        if (category == null) return "bg-secondary";

        if (entertainmentList.Contains(category)) return "bg-warning text-dark";
        if (selfImprovementList.Contains(category)) return "bg-success";
        if (sleepList.Contains(category)) return "bg-info text-white";
        if (workList.Contains(category)) return "bg-primary text-white";

        return "bg-secondary";
    }
}
