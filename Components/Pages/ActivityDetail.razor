@page "/activitydetail/{id:int}"
@rendermode InteractiveServer
@using ActivityManagementApp.Models
@using ActivityManagementApp.ViewModels
@using ActivityManagementApp.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

@inject ActivityInputService _activityInputService
@inject FindActivityLogsService _findActivityLogsService
@inject FindMasterServices _findMasterServices
@inject NavigationManager NavigationManager

<PageTitle>詳細編集</PageTitle>

<div class="container mt-4">
    <h1 class="mb-3">詳細画面</h1>

    @if (activity == null)
    {
        <div class="alert alert-danger">
            データが見つかりませんでした。
        </div>
        return;
    }

    <!-- カテゴリ情報 -->
    <div class="badge
                @ColorClassBuilder.BuildBackgroundBadgeClass(
                                    GetColorKey(activity.CategoryMaster.CategoryTypeMasterId),
                                    GetTextColorKey(activity.CategoryMaster.CategoryTypeMasterId)
              )">
        @activity.CategoryMaster.CategoryName
    </div>

    <div class="text-muted mb-3">
        @activity.StartDateTime.ToString("HH:mm") ～ @activity.EndDateTime.ToString("HH:mm")
        （@activity.PassingRoundMinutes 分）
    </div>

    <EditForm Model="inputModel" OnValidSubmit="UpdateDetail" FormName="detail-edit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-3">
            <label class="form-label">タスクタイトル</label>
            <InputText class="form-control" @bind-Value="inputModel.ActivityDetailTitle" />
            <ValidationMessage For="() => inputModel.ActivityDetailTitle" class="text-danger" />
        </div>

        <div class="mb-3">
            <label class="form-label">詳細メモ</label>
            <InputTextArea class="form-control" rows="10" @bind-Value="inputModel.ActivityDetail" />
            <ValidationMessage For="() => inputModel.ActivityDetail" class="text-danger" />
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">変更を保存</button>
            <button class="btn btn-secondary" @onclick="BackToList">戻る</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int id { get; set; }

    private ActivityLogs? activity;
    private ActivityInputViewModel inputModel = new();
    private List<CategoryTypeMaster> _categoryTypeMasters = new();

    protected override async Task OnInitializedAsync()
    {
        _categoryTypeMasters = await _findMasterServices.FindCategoryTypeMaster();

        activity = await _findActivityLogsService.FindActivityLogsByIdAsync(id);

        if (activity != null)
        {
            inputModel.ActivityDetailTitle = activity.ActivityDetailTitle ?? "";
            inputModel.ActivityDetail = activity.ActivityDetail ?? "";
        }
    }

    private async Task UpdateDetail()
    {
        if (activity == null) return;

        activity.ActivityDetailTitle = inputModel.ActivityDetailTitle;
        activity.ActivityDetail = inputModel.ActivityDetail;

        await _activityInputService.UpdateActivityDetailAsync(activity);

        NavigationManager.NavigateTo("/activitylogslist");
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/activitylogslist");
    }

    private string GetColorKey(int typeId)
    {
        return _categoryTypeMasters.FirstOrDefault(x => x.Id == typeId)?.ColorKey ?? "secondary";
    }

    private string GetTextColorKey(int typeId)
    {
        return _categoryTypeMasters.FirstOrDefault(x => x.Id == typeId)?.TextColorKey ?? "white";
    }
}