@page "/activitydetail/{Id:int}"
@rendermode InteractiveServer
@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@using ActivityManagementApp.ViewModels
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject FindActivityLogsService _findActivityLogsService
@inject ActivityInputService _activityInputService

<PageTitle>詳細画面</PageTitle>

<!-- トースト通知領域 -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    @if (!string.IsNullOrEmpty(toastMessage))
    {
        <div class="toast show align-items-center text-white bg-@toastType border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">@toastMessage</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="HideToast"></button>
            </div>
        </div>
    }
</div>

<div class="container mt-4">
    <h1 class="mb-3">詳細画面</h1>

    @if (_activityLog != null)
    {
        <EditForm Model="inputModel" OnValidSubmit="UpdateActivityDetailAsync" OnInvalidSubmit="ShowValidationErrorToast">
            <DataAnnotationsValidator />

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-bold">
                    @string.Format("{0} {1} ～ {2} （{3}）",
                    _activityLog.StartDateTime.ToShortDateString(),
                                _activityLog.StartDateTime.ToShortTimeString(),
                                _activityLog.EndDateTime.ToShortTimeString(),
                                _activityLog.Category)
            </div>

            <div class="card-body">

                <!-- タイトル -->
                <div class="mb-3">
                    <label class="form-label fw-bold">タイトル</label>
                    <InputText class="@TitleInputClass" @bind-Value="inputModel.ActivityDetailTitle" />
                    <ValidationMessage For="@(() => inputModel.ActivityDetailTitle)" />
                </div>

                <!-- 詳細内容 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">詳細内容</label>
                    <InputTextArea class="@DetailInputClass" rows="10" @bind-Value="inputModel.ActivityDetail" />
                    <ValidationMessage For="@(() => inputModel.ActivityDetail)" />
                </div>

                <div class="d-flex gap-2">
                    <a href="/activitylogslist" class="btn btn-outline-primary">一覧へ戻る</a>
                    <button class="btn btn-success" type="submit">内容を更新</button>
                </div>
            </div>
        </div>
    </EditForm>
        }
    else
    {
        <div class="alert alert-danger">データが見つかりませんでした。</div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private ActivityLogs? _activityLog = new();
    private ActivityInputViewModel inputModel = new();

    private Dictionary<string, string> validationErrors = new();

    private string TitleInputClass => validationErrors.ContainsKey(nameof(inputModel.ActivityDetailTitle)) ? "form-control is-invalid" : "form-control";
    private string DetailInputClass => validationErrors.ContainsKey(nameof(inputModel.ActivityDetail)) ? "form-control is-invalid" : "form-control";

    // トースト通知用
    private string? toastMessage;
    private string toastType = "success";

    protected override async Task OnInitializedAsync()
    {
        _activityLog = await _findActivityLogsService.FindActivityLogsById(Id);

        if (_activityLog != null)
        {
            inputModel.ActivityDetailTitle = _activityLog.ActivityDetailTitle ?? "";
            inputModel.ActivityDetail = _activityLog.ActivityDetail ?? "";
        }
    }

    private async Task UpdateActivityDetailAsync()
    {
        validationErrors.Clear();

        if (_activityLog != null)
        {
            _activityLog.ActivityDetailTitle = inputModel.ActivityDetailTitle;
            _activityLog.ActivityDetail = inputModel.ActivityDetail;

            await _activityInputService.UpdateActivityDetailAsync(_activityLog);
            ShowToast("内容を更新しました。", "success");
        }
    }

    private void ShowValidationErrorToast(EditContext editContext)
    {
        validationErrors.Clear();

        foreach (var field in editContext.GetValidationMessages())
        {
            validationErrors[field] = field;
        }

        ShowToast("入力内容にエラーがあります。確認してください。", "danger");
        StateHasChanged();
    }

    private async void ShowToast(string message, string type)
    {
        toastMessage = $"[{DateTime.Now:HH:mm}] {message}";
        toastType = type;

        await Task.Delay(4000);

        await InvokeAsync(() =>
        {
            toastMessage = null;
            StateHasChanged();
        });
    }

    private void HideToast()
    {
        toastMessage = null;
    }
}
