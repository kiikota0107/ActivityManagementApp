@page "/activitydetail/{Id:int}"
@rendermode InteractiveServer
@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@inject FindActivityLogsService _findActivityLogsService
@inject ActivityInputService _activityInputService

<PageTitle>詳細画面</PageTitle>

<!-- トースト通知領域 -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    @if (!string.IsNullOrEmpty(toastMessage))
    {
        <div class="toast show align-items-center text-white bg-@toastType border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">@toastMessage</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="HideToast"></button>
            </div>
        </div>
    }
</div>

<div class="container mt-4">
    <h1 class="mb-3">詳細画面</h1>

    @if (_activityLog != null)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">
                @string.Format("{0} {1} ～ {2}   （{3}）",
                _activityLog.StartDateTime.ToShortDateString(),
                        _activityLog.StartDateTime.ToShortTimeString(),
                        _activityLog.EndDateTime.ToShortTimeString(),
                        _activityLog.Category)
        </div>
        <div class="card-body">

            <div class="mb-3">
                <label class="form-label fw-bold">タイトル</label>
                <input class="form-control" @bind="_activityLog.ActivityDetailTitle" placeholder="記録した内容の概要" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">詳細内容</label>
                <textarea class="form-control" rows="10" @bind="_activityLog.ActivityDetail" placeholder="詳細なメモや振り返りを記録"></textarea>
            </div>

            <a href="/activitylogslist" class="btn btn-outline-primary">一覧へ戻る</a>
            <button class="btn btn-outline-success" @onclick="UpdateActivityDetailAsync">内容を更新</button>
        </div>
    </div>
        }
    else
    {
        <div class="alert alert-danger">データが見つかりませんでした。</div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private ActivityLogs _activityLog = new ActivityLogs();

    // トースト通知用
    private string? toastMessage;
    private string toastType = "success";

    protected override async Task OnInitializedAsync()
    {
        _activityLog = await _findActivityLogsService.FindActivityLogsById(Id);
    }

    private async Task UpdateActivityDetailAsync()
    {
        await _activityInputService.UpdateActivityDetailAsync(_activityLog);
        ShowToast("内容を更新しました。", "success");
    }

    private async void ShowToast(string message, string type)
    {
        toastMessage = $"[{DateTime.Now:HH:mm}] {message}";
        toastType = type;

        await Task.Delay(4000);

        await InvokeAsync(() =>
        {
            toastMessage = null;
            StateHasChanged();
        });
    }

    private void HideToast()
    {
        toastMessage = null;
    }
}
