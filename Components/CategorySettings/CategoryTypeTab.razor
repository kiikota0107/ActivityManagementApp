@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@using ActivityManagementApp.ViewModels
@using Microsoft.AspNetCore.Components.Web
@inject FindMasterServices _findMasterServices
@inject CategorySettingsService _categorySettingsService
@inject IJSRuntime JS

<h4 class="mb-3">カテゴリタイプ管理</h4>

<!-- ▼ エラーメッセージ表示 -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        @errorMessage
    </div>
}

<!-- ★ 編集フォーム or 一覧 の切り替え -->
@if (isEditing)
{
    <CategoryTypeForm
        Model="editingModel"
        OnSave="HandleSave"
        OnCancel="HandleCancel" />
}
else
{
    <button class="btn btn-primary mb-3" @onclick="StartCreate">
        ＋ 新規カテゴリタイプ
    </button>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>名前</th>
                <th>背景色</th>
                <th>文字色</th>
                <th>並び順</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var type in categoryTypes)
            {
                <tr draggable="true"
                    @ondragstart="() => draggingId = type.Id"
                    @ondragover="OnDragOver"
                    @ondragover:preventDefault="true"
                    @ondrop="() => OnDrop(type.Id)">
                    <td>@type.TypeName</td>
                    <td>@type.ColorKey</td>
                    <td>@type.TextColorKey</td>
                    <td>@type.SortOrder</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(type)">
                            編集
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(type)">
                            削除
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button class="btn btn-success mt-2"
            @onclick="SaveSortOrder">
        並び順を保存
    </button>
}

@code {
    private List<CategoryTypeMaster> categoryTypes = new();
    private bool isEditing = false;
    private int? draggingId = null;

    private string? errorMessage;

    // フォームに渡す ViewModel
    private CategoryTypeEditViewModel editingModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoryTypesAsync();
    }

    private async Task LoadCategoryTypesAsync()
    {
        categoryTypes = (await _findMasterServices.FindCategoryTypeMaster())
                            .OrderBy(t => t.SortOrder).ToList();
    }

    private void StartCreate()
    {
        errorMessage = null;
        editingModel = new CategoryTypeEditViewModel();
        isEditing = true;
    }

    private void StartEdit(CategoryTypeMaster type)
    {
        errorMessage = null;

        // ★ Entity → ViewModel へ変換（深いコピー）
        editingModel = new CategoryTypeEditViewModel
        {
            Id = type.Id,
            TypeName = type.TypeName,
            ColorKey = type.ColorKey,
            TextColorKey = type.TextColorKey,
            SortOrder = type.SortOrder
        };

        isEditing = true;
    }

    private async Task HandleSave(CategoryTypeEditViewModel model)
    {
        errorMessage = null;

        // ★ ViewModel → Entity へ変換
        var entity = new CategoryTypeMaster
        {
            Id = model.Id,
            TypeName = model.TypeName,
            ColorKey = model.ColorKey,
            TextColorKey = model.TextColorKey,
            SortOrder = model.SortOrder
        };

        if (entity.Id == 0)
        {
            await _categorySettingsService.InsertCategoryTypeAsync(entity);
        }
        else
        {
            await _categorySettingsService.UpdateCategoryTypeAsync(entity);
        }

        await LoadCategoryTypesAsync();
        isEditing = false;
    }

    private Task HandleCancel()
    {
        errorMessage = null;
        isEditing = false;
        return Task.CompletedTask;
    }

    private async Task Delete(CategoryTypeMaster target)
    {
        errorMessage = null;

        bool confirm = await JS.InvokeAsync<bool>("confirm",
            $"{target.TypeName} を削除しますか？");

        if (!confirm) return;

        bool success = await _categorySettingsService.DeleteCategoryTypeAsync(target.Id);

        if (!success)
        {
            errorMessage = $"カテゴリタイプ「{target.TypeName}」は使用されているため削除できません。";
        }

        await _categorySettingsService.DeleteCategoryTypeAsync(target.Id);
        await LoadCategoryTypesAsync();
    }

    private void OnDrop(int targetId)
    {
        if (draggingId == null || draggingId == targetId) return;

        var draggedRecord = categoryTypes.FirstOrDefault(x => x.Id == draggingId);
        var targetRecord = categoryTypes.FirstOrDefault(x => x.Id == targetId);

        if (draggedRecord == null || targetRecord == null) return;

        int oldIndex = categoryTypes.IndexOf(draggedRecord);
        int newIndex = categoryTypes.IndexOf(targetRecord);

        categoryTypes.RemoveAt(oldIndex);
        categoryTypes.Insert(newIndex, draggedRecord);

        draggingId = null;
    }

    private async Task SaveSortOrder()
    {
        var orderedIds = categoryTypes.Select(x => x.Id).ToList();
        await _categorySettingsService.UpdateCategoryTypeSortOrdersAsync(orderedIds);
        await LoadCategoryTypesAsync();
    }

    private void OnDragOver(DragEventArgs e)
    {
        
    }
}