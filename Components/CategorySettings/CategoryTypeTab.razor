@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@inject FindMasterServices _findMasterServices
@inject CategorySettingsService _categorySettingsService

<h4 class="mb-3">カテゴリタイプ管理</h4>

<!-- ★ 編集フォーム or 一覧 の切り替え -->
@if (isEditing)
{
    <CategoryTypeForm
        Model="editingModel"
        OnSave="HandleSave"
        OnCancel="HandleCancel" />
}
else
{
    <button class="btn btn-primary mb-3" @onclick="StartCreate">
        ＋ 新規カテゴリタイプ
    </button>

    <table class="table table-hover">
        <thead>
            <tr>
                <ht>名前</ht>
                <ht>背景色</ht>
                <ht>文字色</ht>
                <ht>並び順</ht>
                <ht></ht>
            </tr>
        </thead>
        <tbody>
            @foreach (var type in categoryTypes)
            {
                <tr>
                    <td>@type.TypeName</td>
                    <td>@type.ColorKey</td>
                    <td>@type.TextColorKey</td>
                    <td>@type.SortOrder</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(type)">
                            編集
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(type)">
                            削除
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<CategoryTypeMaster> categoryTypes = new();
    private bool isEditing = false;

    // フォームに渡すモデル
    private CategoryTypeMaster editingModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoryTypesAsync();
    }

    private async Task LoadCategoryTypesAsync()
    {
        categoryTypes = await _findMasterServices.FindCategoryTypeMaster();
    }

    private void StartCreate()
    {
        editingModel = new CategoryTypeMaster();
        isEditing = true;
    }

    private void StartEdit(CategoryTypeMaster type)
    {
        // ★ 不快コピーにして編集が一覧に即反映されないようにする
        editingModel = new CategoryTypeMaster
            {
                Id = type.Id,
                TypeName = type.TypeName,
                ColorKey = type.ColorKey,
                TextColorKey = type.TextColorKey,
                SortOrder = type.SortOrder
            };

        isEditing = true;
    }

    private async Task HandleSave(CategoryTypeMaster model)
    {
        if (model.Id == 0)
        {
            await _categorySettingsService.InsertCategoryTypeAsync(model);
        }
        else
        {
            await _categorySettingsService.UpdateCategoryTypeAsync(model);
        }

        await LoadCategoryTypesAsync();
        isEditing = false;
    }

    private Task HandleCancel()
    {
        isEditing = false;
        return Task.CompletedTask;
    }

    private async Task Delete(CategoryTypeMaster target)
    {
        await _categorySettingsService.DeleteCategoryTypeAsync(target.Id);
        await LoadCategoryTypesAsync();
    }
}