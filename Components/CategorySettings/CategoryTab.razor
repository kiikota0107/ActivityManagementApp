@using ActivityManagementApp.Models
@using ActivityManagementApp.Services
@using ActivityManagementApp.ViewModels
@using Microsoft.AspNetCore.Components.Web;
@inject FindMasterServices _findMasterServices
@inject CategorySettingsService _categorySettingsService
@inject IJSRuntime JS

<h4 class="mb-3">カテゴリ管理</h4>

<!-- ▼ エラーメッセージ表示 -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        @errorMessage
    </div>
}

@if (isEditing)
{
    <CategoryForm Model="editingModel"
                  CategoryTypes="categoryTypeList"
                  OnSave="HandleSave"
                  OnCancel="HandleCancel" />
}
else
{
    <button class="btn btn-primary mb-3" @onclick="StartCreate">
        ＋ 新規カテゴリ
    </button>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>カテゴリ名</th>
                <th>カテゴリタイプ</th>
                <th>並び順</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cat in categories)
            {
                var type = typeMap.GetValueOrDefault(cat.CategoryTypeMasterId);

                <tr draggable="true"
                    @ondragstart="() => draggingId = cat.Id"
                    @ondragover="OnDragOver"
                    @ondragover:preventDefault="true"
                    @ondrop="() => OnDrop(cat.Id)">
                    <td>@cat.CategoryName</td>
                    <td>
                        <span class="badge
                                 @ColorClassBuilder.BuildBackgroundBadgeClass(
                                                                    type?.ColorKey ?? "secondary",
                                                                    type?.TextColorKey ?? "white")">
                            @GetTypeName(cat.CategoryTypeMasterId)
                        </span>
                    </td>
                    <td>@cat.SortOrder</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2"
                                @onclick="() => StartEdit(cat)">
                            編集
                        </button>
                        <button class="btn btn-sm btn-outline-danger"
                                @onclick="() => Delete(cat)">
                            削除
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button class="btn btn-success mt-2"
            @onclick="SaveSortOrder">
        並び順を保存
    </button>
}

@code {
    private List<CategoryMaster> categories = new();
    private List<CategoryTypeMaster> categoryTypeList = new();
    private Dictionary<int, CategoryTypeMaster> typeMap = new();

    private bool isEditing = false;
    private int? draggingId = null;

    private CategoryEditViewModel editingModel = new();

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        categoryTypeList = (await _findMasterServices.FindCategoryTypeMaster())
                            .OrderBy(t => t.SortOrder)
                            .ToList();

        categories = (await _findMasterServices.FindCategoryMaster())!
                            .OrderBy(c => c.SortOrder)
                            .ToList();

        categoryTypeList = (await _findMasterServices.FindCategoryTypeMaster())
                            .OrderBy(t => t.SortOrder)
                            .ToList();

        typeMap = categoryTypeList.ToDictionary(t => t.Id);
    }

    private string GetTypeName(int typeId)
    {
        return categoryTypeList
            .FirstOrDefault(x => x.Id == typeId)?.TypeName ?? "(削除済み)";
    }

    private string GetTypeColorKey(int typeId)
    {
        return categoryTypeList
            .FirstOrDefault(x => x.Id == typeId)?.ColorKey ?? "";
    }

    private string GetTypeTextColorKey(int typeId)
    {
        return categoryTypeList
            .FirstOrDefault(x => x.Id == typeId)?.TextColorKey ?? "";
    }

    private void StartCreate()
    {
        editingModel = new CategoryEditViewModel();
        isEditing = true;
    }

    private void StartEdit(CategoryMaster cat)
    {
        // ★ Entity → ViewModel（深いコピー）
        editingModel = new CategoryEditViewModel
        {
            Id = cat.Id,
            CategoryName = cat.CategoryName,
            CategoryTypeMasterId = cat.CategoryTypeMasterId,
            SortOrder = cat.SortOrder
        };

        isEditing = true;
    }

    private async Task HandleSave(CategoryEditViewModel model)
    {
        // ★ ViewModel → Entity 変換
        var entity = new CategoryMaster
        {
            Id = model.Id,
            CategoryName = model.CategoryName,
            CategoryTypeMasterId = model.CategoryTypeMasterId,
            SortOrder = model.SortOrder
        };

        if (entity.Id == 0)
        {
            await _categorySettingsService.InsertCategoryAsync(entity);
        }
        else
        {
            var result = await _categorySettingsService.UpdateCategoryAsync(entity);
            if (!result.IsValid) errorMessage = result.ErrorMessage;
        }

        await LoadAsync();
        isEditing = false;
    }

    private Task HandleCancel()
    {
        isEditing = false;
        return Task.CompletedTask;
    }

    private async Task Delete(CategoryMaster target)
    {
        bool confirm = await JS.InvokeAsync<bool>("confirm",
            $"{target.CategoryName} を削除しますか？（過去ログのカテゴリは削除済み扱いになります）");

        if (!confirm) return;

        var result = await _categorySettingsService.DeleteCategoryAsync(target.Id);
        if (!result.IsValid) errorMessage = result.ErrorMessage;

        await LoadAsync();
    }

    private void OnDrop(int targetId)
    {
        if (draggingId == null || draggingId == targetId) return;

        var draggedRecord = categories.FirstOrDefault(x => x.Id == draggingId);
        var targetRecord = categories.FirstOrDefault(x => x.Id == targetId);

        if (draggedRecord == null || targetRecord == null) return;

        int oldIndex = categories.IndexOf(draggedRecord);
        int newIndex = categories.IndexOf(targetRecord);

        categories.RemoveAt(oldIndex);
        categories.Insert(newIndex, draggedRecord);

        draggingId = null;
    }

    private async Task SaveSortOrder()
    {
        var result = await _categorySettingsService.UpdateCategorySortOrdersAsync(categories);
        if (!result.IsValid) errorMessage = result.ErrorMessage;
        await LoadAsync();
    }

    private void OnDragOver(DragEventArgs e)
    {
        
    }
}